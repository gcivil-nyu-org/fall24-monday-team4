{% extends "base.html" %}
{% load trip_filters %}
{% block title %}Find Companions{% endblock %}

{% block content %}

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div class="container mt-4">
    <h4>Find Companions</h4>
    {% if error %}
        <div class="alert alert-warning">
            {{ error }}
            <a href="{% url 'home' %}" class="btn btn-primary ms-3">Create Trip</a>
        </div>
    {% else %}
        <div class="card mb-4">
            <div class="card-header">
                <h4>Your Active Trip</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <p class="mb-0"><strong>Departure:</strong> {{ user_trip.planned_departure }}</p>
                    <p class="mb-0"><strong>Status:</strong> 
                        <span class="badge {% if user_trip.status == 'MATCHED' %}bg-warning
                                       {% elif user_trip.status == 'IN_PROGRESS' %}bg-info
                                       {% elif user_trip.status == 'COMPLETED' %}bg-success
                                       {% else %}bg-secondary{% endif %}">
                            {{ user_trip.status }}
                        </span>
                    </p>
                    {% if user_trip.desired_companions == 0 %}
                        <p class="mb-0"><strong>Group Size:</strong> Open to any</p>
                    {% else %}
                        <p class="mb-0"><strong>Looking for:</strong> {{ user_trip.desired_companions }} companions</p>
                        <p class="mb-0"><strong>Spots left:</strong> {{ user_trip.spots_left }}</p>
                    {% endif %}
                </div>
                <div id="user-trip-map" style="height: 70vh; width: auto;" class="mb-3 position-relative rounded overflow-hidden"></div>
                <div class="d-flex gap-2 justify-content-between">
                    <div class="d-flex gap-2">
                        {% if user_trip.status == "MATCHED" %}
                            {% with match_count=user_trip|accepted_matches_count %}
                                {% if user_trip.desired_companions == 0 or match_count >= user_trip.desired_companions %}
                                    <form method="POST" action="{% url 'start_trip' %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success">Start Trip</button>
                                    </form>
                                {% else %}
                                    <span class="text-warning align-self-center">
                                        Waiting for {{ user_trip.desired_companions|sub:match_count }} more companions before trip can start
                                    </span>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                        <button class="btn btn-secondary" onclick="toggleRouteInstructions()">Show/Hide Route Instructions</button>
                        <form method="POST" action="{% url 'cancel_trip' %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to cancel this trip?')">
                                Cancel Trip
                            </button>
                        </form>
                    </div>
                    {% if user_trip.status == "IN_PROGRESS" %}
                        <button class="btn btn-primary" id="toggleLocations" onclick="toggleLiveLocations()">
                            <i class="fa-solid fa-location-dot"></i> Show Live Locations
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <h4>Available Travel Companions</h4>
        {% if potential_matches %}
            <div class="row row-cols-1 row-cols-md-3 g-4">
                {% for matchdTrip in potential_matches %}
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                {% if matchdTrip.user.profile.photo_key %}
                                    <img src="{{ matchdTrip.user.profile.get_photo_url }}" alt="Profile Picture"
                                        class="rounded-circle me-2" style="width: 50px; height: 50px; object-fit: cover;">
                                {% else %}
                                    <div class="rounded-circle me-2 d-flex align-items-center justify-content-center"
                                        style="width: 50px; height: 50px; background-color: black; color: white;">
                                        ?
                                    </div>
                                {% endif %}
                                <h5 class="card-title mb-0">{{ matchdTrip.user.username }}</h5>
                            </div>
                            <div class="mb-3">
                                <p class="mb-0">Departure: {{ matchdTrip.planned_departure }}</p>
                                {% if matchdTrip.desired_companions == 0 %}
                                    <p class="mb-0">Group Size: Open to any</p>
                                {% else %}
                                    <p class="mb-0">Looking for: {{ matchdTrip.desired_companions }} companions</p>
                                    <p class="mb-0">Spots left: {{ matchdTrip.spots_left }}</p>
                                {% endif %}
                            </div>
                            <form method="POST" action="{% url 'send_match_request' %}">
                                {% csrf_token %}
                                <input type="hidden" name="trip_id" value="{{ matchdTrip.id }}">
                                <button type="button"
                                        class="request-btn btn {% if matchdTrip.has_pending_request %}btn-warning{% else %}btn-primary{% endif %}"
                                        data-trip-id="{{ matchdTrip.id }}"
                                        data-status="{% if matchdTrip.has_pending_request %}requested{% else %}send{% endif %}">
                                    {{ matchdTrip.has_pending_request|yesno:"Requested,Request" }}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                No potential companion matches found at this time. Check back later!
            </div>
        {% endif %}
    {% endif %}
</div>

<script>
    // Add this JavaScript function
    function toggleRouteInstructions() {
        const container = document.querySelector('.leaflet-routing-container');
        if (container.style.display === 'none') {
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }
    
    // At the start, before creating new map
    if (window.map) {
        // Clear all markers and controls
        window.map.eachLayer((layer) => {
            layer.remove();
        });
        window.map.remove();
    }

    window.map = L.map('user-trip-map').setView([
        parseFloat({{user_trip.start_latitude}}), 
        parseFloat({{user_trip.start_longitude}})
    ], 13);
    
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        // attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(window.map);

    const startIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    const destIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    const startMarker = L.marker([
        parseFloat({{user_trip.start_latitude}}), 
        parseFloat({{user_trip.start_longitude}})
    ], {icon: startIcon})
    .bindPopup('Your Start Location')
    .addTo(window.map);
    
    const destMarker = L.marker([
        parseFloat({{user_trip.dest_latitude}}), 
        parseFloat({{user_trip.dest_longitude}})
    ], {icon: destIcon})
    .bindPopup('Your Destination')
    .addTo(window.map);

    const routingControl = L.Routing.control({
        waypoints: [
            L.latLng(parseFloat({{user_trip.start_latitude}}), parseFloat({{user_trip.start_longitude}})),
            L.latLng(parseFloat({{user_trip.dest_latitude}}), parseFloat({{user_trip.dest_longitude}}))
        ],
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1',
            // Available profiles:
            // 'foot' - Walking/Pedestrian routes
            // 'bike' - Cycling routes
            // 'car' - Driving routes (default)
            // 'walking' - Alternative for foot
            // 'cycling' - Alternative for bike
            // 'driving' - Alternative for car
            profile: 'foot'  
            
        }),
        showAlternatives: true,
        formatLine: function(line) {
            const duration = Math.round(line.summary.totalTime / 60); // Convert seconds to minutes
            return `${duration} min - ${line.summary.totalDistance} m`;
        },
        lineOptions: {
            styles: [{color: 'blue', opacity: 0.6, weight: 4}],
            extendToWaypoints: true,
            missingRouteTolerance: 0
        },
        alternativeStyles: {
            styles: [
                    {color: '#B1D690', opacity: 0.6, weight: 4},
                    {color: '#FEEC37', opacity: 0.6, weight: 4},
                    {color: '#FFA24C', opacity: 0.6, weight: 4}
                ]
        },
        createMarker: function() { return null; },  // Disable default markers
        addWaypoints: false,  // Prevent adding new waypoints
        draggableWaypoints: false,  // Prevent dragging waypoints
        routeWhileDragging: false,
        show: true  // Hide the routing instructions panel
    }).addTo(window.map);

    // const routeLine = L.polyline([
    // [parseFloat({{user_trip.start_latitude}}), parseFloat({{user_trip.start_longitude}})],
    // [parseFloat({{user_trip.dest_latitude}}), parseFloat(user_trip.dest_longitude)]
    //     ], {
    //         color: 'blue',
    //         opacity: 0.6,
    //         weight: 4,
    //         dashArray: '10, 10'  // Makes line dashed
    //     }).addTo(window.map);

    // Fit bounds to markers
    const bounds = L.latLngBounds(
        [parseFloat({{user_trip.start_latitude}}), parseFloat({{user_trip.start_longitude}})],
        [parseFloat({{user_trip.dest_latitude}}), parseFloat({{user_trip.dest_longitude}})]
    );

    window.map.fitBounds(bounds, {padding: [50, 50]});

    // Map Stuff For Live Tracking
    let locationUpdateInterval = null;
    let companionMarkers = {};
    let userLocationMarker = null;
    let userMarkerCircle = null;  // For accuracy radius
    let currFeatureGroup = null;
    let locationFoundHandler = null;

    const userIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    let showingLocations = false;

    function toggleLiveLocations() {
        const button = document.getElementById('toggleLocations');
        showingLocations = !showingLocations;
        
        if (showingLocations) {
            button.innerHTML = '<i class="fa-solid fa-location-dot"></i> Hide Live Locations';
            if (currFeatureGroup) currFeatureGroup.addTo(window.map);
            Object.values(companionMarkers).forEach(marker => marker.addTo(window.map));
        } else {
            button.innerHTML = '<i class="fa-solid fa-location-dot"></i> Show Live Locations';
            if (currFeatureGroup) window.map.removeLayer(currFeatureGroup);
            Object.values(companionMarkers).forEach(marker => window.map.removeLayer(marker));
        }
    }

    function updateUserLocation() {
        // Remove previous listener if exists
        if (locationFoundHandler) {
            window.map.off('locationfound', locationFoundHandler);
        }

        window.map.locate({
            setView: false,  // Don't auto-pan to location
            enableHighAccuracy: true
        });

        locationFoundHandler = function(e) {
            const latitude = e.latitude;
            const longitude = e.longitude;
            const accuracy = e.accuracy;
            const pos = [latitude, longitude];

            // Update or create marker
            if (userLocationMarker) {
                userLocationMarker.setLatLng(pos);
            } else {
                userLocationMarker = L.marker(pos, {icon: userIcon})
                .bindPopup(`Your Current Location:<br>
                    Latitude: ${latitude}<br>
                    Longitude: ${longitude}<br>
                    Accuracy: ${accuracy}m`)    
            }

            // Update or create accuracy circle
            if (userMarkerCircle) {
                userMarkerCircle.setLatLng(pos);
                userMarkerCircle.setRadius(accuracy);
            } else {
                userMarkerCircle = L.circle(pos, {
                    radius: accuracy,
                    interactive: false
                })    
            }

            // Remove old feature group if exists
            if (currFeatureGroup) {
                window.map.removeLayer(currFeatureGroup);
            }

            currFeatureGroup = L.featureGroup([userLocationMarker, userMarkerCircle])                        
                                    
            if (showingLocations) {
                currFeatureGroup.addTo(window.map);
            }

            // Send location to server
            fetch('{% url "update_location" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    'latitude': latitude,
                    'longitude': longitude
                })
            });
        };

        window.map.on('locationfound', locationFoundHandler);

        window.map.on('locationerror', function(e) {
            console.log('Unable to find location:', e.message);
        });
    }

    // Different icons for companions
    const companionIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    function updateCompanionLocations() {
        fetch('{% url "get_trip_locations" %}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.locations.forEach(loc => {
                        let marker = companionMarkers[loc.user__username];
                        const position = [loc.latitude, loc.longitude];
                        
                        if (marker) {
                            marker.setLatLng(position);
                        } else {
                            marker = L.marker(position, {icon: companionIcon})
                                .bindPopup(loc.user__username)
                            companionMarkers[loc.user__username] = marker;
                        }

                        if (showingLocations) {
                            marker.addTo(window.map);
                        }
                    });
                }
            });
    }

    // Start/stop location updates based on trip status
    if ("{{user_trip.status}}" == "IN_PROGRESS"){
        // Update location every 10 seconds
        locationUpdateInterval = setInterval(() => {
            updateUserLocation();
            updateCompanionLocations();
        }, 10000);
        
        // Initial update
        updateUserLocation();
        updateCompanionLocations();
    }

    // Cleanup on page unload
    window.onunload = function() {
        if (locationUpdateInterval) {
            clearInterval(locationUpdateInterval);
        }
    };
</script>

<script>
    document.querySelectorAll('.request-btn').forEach(button => {
        button.addEventListener('click', function() {
            const tripId = this.dataset.tripId;
            const action = this.dataset.status === 'requested' ? 'cancel' : 'send';
    
            fetch('{% url "send_match_request" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `trip_id=${tripId}&action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (action === 'send') {
                        this.textContent = 'Requested';
                        this.classList.replace('btn-primary', 'btn-warning');
                        this.dataset.status = 'requested';
                    } else {
                        this.textContent = 'Request';
                        this.classList.replace('btn-warning', 'btn-primary');
                        this.dataset.status = 'send';
                    }
                }
            });
        });
    });
</script>

{% endblock %}