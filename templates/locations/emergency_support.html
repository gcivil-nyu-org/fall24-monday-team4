{% extends "base.html" %}
{% load static %}

{% block title %}Emergency Support{% endblock %}

{% block content %}
<h1>All User Locations</h1>
<div id="map" style="height: 500px; width: 100%;"></div>
<div id="panic-alert" class="mt-4" style="display: none;">
    <h3>Active Panic Detected!</h3>
    <p id="panic-coordinates"></p>
    <button id="cancel-panic" class="btn btn-danger">Cancel Panic</button>
</div>

<script>
    const locations = {{ user_locations_json|safe }};
    const map = L.map('map').setView([0, 0], 2); // World view

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    const markers = {}; // Object to store markers by location ID

    function getMarkerIcon(panic) {
        return L.icon({
            iconUrl: panic 
                ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png' 
                : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    // Add initial markers to the map
    locations.forEach(location => {
        const marker = L.marker([location.latitude, location.longitude], {icon: getMarkerIcon(location.panic)})
            .addTo(map)
            .bindTooltip(location.username, {
                permanent: true,
                direction: 'top',
                offset: [0, -10]
            })
            .bindPopup(`User: ${location.username}<br>Latitude: ${location.latitude}<br>Longitude: ${location.longitude}`);

        markers[location.id] = marker; // Store marker by ID
    });

    const bounds = L.latLngBounds(locations.map(loc => [loc.latitude, loc.longitude]));
    map.fitBounds(bounds);

    let activePanic = null; // Track the active panic location

    function updateMarkers() {
        fetch("{% url 'emergency_support' %}", {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            data.forEach(location => {
                if (markers[location.id]) {
                    markers[location.id].setIcon(getMarkerIcon(location.panic));
                } else {
                    const newMarker = L.marker([location.latitude, location.longitude], {icon: getMarkerIcon(location.panic)})
                        .addTo(map)
                        .bindTooltip(location.username, {
                            permanent: true,
                            direction: 'top',
                            offset: [0, -10]
                        })
                        .bindPopup(`User: ${location.username}<br>Latitude: ${location.latitude}<br>Longitude: ${location.longitude}`);

                    markers[location.id] = newMarker;
                }

                // Check for panic status and display alert
                if (location.panic && (!activePanic || activePanic.id !== location.id)) {
                    activePanic = location; // Set active panic
                    document.getElementById('panic-alert').style.display = 'block';
                    document.getElementById('panic-coordinates').textContent = 
                        `User: ${location.username}, Latitude: ${location.latitude}, Longitude: ${location.longitude}, Panic Message: ${location.panic_message}`;
                }
            });

            // Hide the panic alert if no active panic
            if (!data.some(location => location.panic)) {
                activePanic = null;
                document.getElementById('panic-alert').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error updating markers:', error);
            alert(`Failed to update markers: ${error.message}`);
        });
    }

    document.getElementById('cancel-panic').addEventListener('click', () => {
    if (activePanic) {
        // Construct the URL dynamically with the username (panic_user)
        const url = `{% url 'cancel_panic' panic_username='username_placeholder' %}`.replace('username_placeholder', activePanic.username);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Panic canceled successfully.');
                activePanic = null;
                document.getElementById('panic-alert').style.display = 'none';
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error canceling panic:', error);
            alert(`Failed to cancel panic: ${error.message}`);
        });
    }
});


    setInterval(updateMarkers, 5000);
</script>
{% endblock %}
