{% extends "base.html" %}

{% block title%}Chat Room{% endblock %}

{% block content %}

<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Trip Group Chat</h5>
            {% if is_archive %}
                <span class="badge bg-secondary">Archived Chat History</span>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="chat-messages p-3" id="messageContainer" style="height: 400px; overflow-y: auto;">
                {% for message in messages %}
                <div class="message mb-2">
                    <small class="text-muted">{{ message.user.username }} - {{ message.created_at|date:'g:i A' }}</small>
                    <div class="message-content p-2 rounded {% if message.user == request.user %}bg-primary text-white float-end{% else %}bg-light{% endif %}">
                        {{ message.message }}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if not is_archive %}
            <div class="chat-input mt-3">
                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                    <button class="btn btn-primary" id="sendButton" type="button">Send</button>
                </div>
            </div>
            
            <div id="connectionStatus" class="alert alert-warning mt-2" style="display: none;">
                Connecting...
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    const messageContainer = document.getElementById('messageContainer');
    
    {% if not is_archive %}
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const statusDiv = document.getElementById('connectionStatus');
      let chatSocket = null;

      function connectWebSocket() {
          chatSocket = new WebSocket(
              'ws://' + window.location.host + '/ws/chat/{{ chat_room.id }}/'
          );

          chatSocket.onopen = function(e) {
              statusDiv.style.display = 'none';
          };

          chatSocket.onmessage = function(e) {
              const data = JSON.parse(e.data);
              addMessage(data.username, data.message);
          };

          chatSocket.onclose = function(e) {
              statusDiv.style.display = 'block';
              statusDiv.className = 'alert alert-warning mt-2';
              statusDiv.textContent = 'Connection lost. Reconnecting...';
              setTimeout(connectWebSocket, 2000);
          };

          chatSocket.onerror = function(e) {
              statusDiv.style.display = 'block';
              statusDiv.className = 'alert alert-danger mt-2';
              statusDiv.textContent = 'Connection error occurred.';
          };
      }

      function addMessage(username, message) {
          const msgDiv = document.createElement('div');
          msgDiv.className = 'message mb-2';
          const isCurrentUser = username === "{{ request.user.username }}";
          
          msgDiv.innerHTML = `
              <small class="text-muted">${username} - ${new Date().toLocaleTimeString()}</small>
              <div class="message-content p-2 rounded ${isCurrentUser ? 'bg-primary text-white float-end' : 'bg-light'}">
                  ${message}
              </div>
          `;
          
          messageContainer.appendChild(msgDiv);
          messageContainer.scrollTop = messageContainer.scrollHeight;
      }

      messageInput.onkeyup = function(e) {
          if (e.keyCode === 13) {
              sendButton.click();
          }
      };

      sendButton.onclick = function(e) {
          const message = messageInput.value.trim();
          if (message) {
              chatSocket.send(JSON.stringify({
                  'message': message,
                  'username': "{{ request.user.username }}",
                  'chat_room': "{{ chat_room.name }}"
              }));
              messageInput.value = '';
          }
      };

      connectWebSocket();

      // Cleanup on page unload/switch
      window.onbeforeunload = function() {
          if (chatSocket) {
              chatSocket.close();
          }
      };
      
      // Cleanup on component unmount
      document.addEventListener("visibilitychange", function() {
          if (document.visibilityState === 'hidden' && chatSocket) {
              chatSocket.close();
          }
      });
    {% endif %}

    // Scroll to bottom on load
    messageContainer.scrollTop = messageContainer.scrollHeight;
</script>
{% endblock %}