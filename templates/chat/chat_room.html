{% extends "base.html" %}

{% block title%}Chat Room{% endblock %}

{% block content %}

<style>
    .system-message .message-content {
        background-color: #f8f9fa !important;
        border-left: 4px solid #6c757d;
        font-style: italic;
        width: 100%;
        text-align: center;
    }
    
    .system-message small {
        color: #6c757d !important;
        font-weight: 500;
    }
    
    .chat-messages {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .message-timestamp {
        font-size: 0.75rem;
        color: #6c757d;
    }
</style>

<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Trip Group Chat</h5>
            {% if is_archive %}
                <span class="badge bg-secondary">Archived Chat History</span>
            {% else %}
                <span class="badge {% if trip.status == 'MATCHED' %}bg-warning
                               {% elif trip.status == 'READY' %}bg-info
                               {% elif trip.status == 'IN_PROGRESS' %}bg-primary{% endif %}">
                    {{ trip.status }}
                </span>
            {% endif %}
        </div>
        <div class="card-body">            
            <div class="chat-messages p-3" id="messageContainer" style="height: 400px; overflow-y: auto;">
                {% for message in messages %}
                    <div class="message mb-2 {% if message.user.is_staff %}system-message{% endif %}">
                        {% if message.user.is_staff %}
                            <div class="message-content p-2 rounded">
                                {{ message.message }}
                                <div class="message-timestamp">{{ message.created_at|date:'g:i A' }}</div>
                            </div>
                        {% else %}
                            <div class="d-flex {% if message.user == request.user %}justify-content-end{% endif %}">
                                <div class="message-content p-2 rounded {% if message.user == request.user %}bg-primary text-white{% else %}bg-light{% endif %}">
                                    <strong>{{ message.user.username }}</strong>
                                    <p class="mb-0">{{ message.message }}</p>
                                    <div class="message-timestamp">{{ message.created_at|date:'g:i A' }}</div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            {% if not is_archive %}
                <div class="chat-input mt-3">
                    <div class="input-group">
                        <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                        <button class="btn btn-primary" id="sendButton" type="button">Send</button>
                    </div>
                </div>
            
                <div id="connectionStatus" class="alert alert-warning mt-2" style="display: none;">
                    Connecting...
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    const messageContainer = document.getElementById('messageContainer');
    
    if (!{{is_archive|yesno:"true,false"}}) {
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const statusDiv = document.getElementById('connectionStatus');

        const pusher = new Pusher('{{ pusher_key }}', {
            cluster: '{{ pusher_cluster }}'
        });
        
        const channel = pusher.subscribe('chat-{{ chat_room.id }}');
        
        channel.bind('new-message', function(data) {
            if (data.type === 'system') {
                addSystemMessage(data.message);
            } else {
                addUserMessage(data.username, data.message);
            }
        });

        pusher.connection.bind('state_change', function(states) {
            if (states.current === 'connected') {
                statusDiv.style.display = 'none';
            } else {
                statusDiv.style.display = 'block';
                statusDiv.className = 'alert alert-warning mt-2';
                statusDiv.textContent = 'Connection lost. Reconnecting...';
            }
        });
    
        function addSystemMessage(message) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message mb-2 system-message';
            msgDiv.innerHTML = `
                <small class="text-muted">System Message - ${new Date().toLocaleTimeString()}</small>
                <div class="message-content p-2 rounded bg-light text-dark">
                    ${message}
                </div>
            `;
            messageContainer.appendChild(msgDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
    
        function addUserMessage(username, message) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message mb-2';
            const isCurrentUser = username === "{{ request.user.username }}";
            
            msgDiv.innerHTML = `
                <small class="text-muted">${username} - ${new Date().toLocaleTimeString()}</small>
                <div class="message-content p-2 rounded ${isCurrentUser ? 'bg-primary text-white float-end' : 'bg-light'}">
                    ${message}
                </div>
            `;
            
            messageContainer.appendChild(msgDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
    
        messageInput.onkeyup = function(e) {
            if (e.keyCode === 13 && !e.shiftKey) {
                sendButton.click();
            }
        };
    
        sendButton.onclick = function(e) {
            const message = messageInput.value.trim();
            if (message) {
                fetch('/chat/send_message/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        'message': message,
                        'chat_room': '{{ chat_room.id }}'
                    })
                }).then(response => {
                    if (response.ok) {
                        messageInput.value = '';
                    } else {
                        console.error('Failed to send message');
                    }
                });
            }
        };
    
    
        // Cleanup on page unload
        window.onbeforeunload = function() {
            pusher.unsubscribe('chat-{{ chat_room.id }}');
        };

        // Cleanup on component unmount
        document.addEventListener("visibilitychange", function() {
            if (document.visibilityState === 'hidden') {
                pusher.unsubscribe('chat-{{ chat_room.id }}');
            }
        });
    }
    
    // Always scroll to bottom on load
    messageContainer.scrollTop = messageContainer.scrollHeight;
</script>
{% endblock %}